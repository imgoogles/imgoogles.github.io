<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Planespotting</title>
<style>
    body {
        font-family: Arial;
        padding: 0;
        background-color: black;
        color: white;
        min-height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .container {
        width: 100%;
        max-width: 500px;
        padding: 20px;
        box-sizing: border-box;
    }

    h2 {
        text-align: center;
        font-size: 28px;
        margin-bottom: 20px;
    }

    textarea, input {
        width: 100%;
        background-color: black;
        border: 1px solid white;
        color: white;
        margin: 8px 0;
        padding: 10px;
        font-size: 18px;
        border-radius: 4px;
        box-sizing: border-box;
    }

    button {
        width: 100%;
        padding: 14px;
        margin-top: 14px;
        border: 1px solid white;
        background: transparent;
        color: white;
        font-size: 18px;
        cursor: pointer;
        border-radius: 4px;
    }

    button:active {
        opacity: 0.6;
    }

    #log {
        white-space: pre-line;
        margin-top: 20px;
        width: 100%;
        background: rgba(255,255,255,0.05);
        padding: 12px;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box;
    }

    @media (max-width: 420px) {
        h2 { font-size: 22px; }
        textarea, input, button { font-size: 16px; }
    }
</style>
</head>
<body>

<div class="container">

<h2>Aircraft Registrations → CSV</h2>

<label>Date:</label>
<input id="date_input" type="text" placeholder="e.g. 12.11.2025">

<label>Airport:</label>
<input id="airport_input" type="text" placeholder="e.g. PRG, OTP, CPH">

<label>Registrations (space separated):</label>
<textarea id="regs_input" rows="4" placeholder="OK-IOO YR-AME ..."></textarea>

<button onclick="startProcess()">Generate CSV</button>

<div id="log"></div>

</div>

<script>
async function fetchAircraftInfo(registration) {
    const realURL = `https://www.jetapi.dev/api?reg=${registration}&photos=1&flights=0`;
    const url = `https://corsproxy.io/?${realURL}`;

    try {
        const resp = await fetch(url, { headers: { "User-Agent": "Mozilla/5.0" }});
        if (!resp.ok) {
            document.getElementById("log").innerText += `❌ ${registration}: HTTP ${resp.status}\n`;
            return {
                Registration: registration,
                Type: "N/A",
                Airline: "N/A",
                Thumbnail: "N/A",
                FullImage: "N/A"
            };
        }

        const data = await resp.json();

        const fr = data.FlightRadar || {};
        const jp = data.JetPhotos || {};
        const images = jp.Images || [];
        const photo = images[0];

        const type =
            (fr.Aircraft) ||
            (photo && photo.Aircraft) ||
            "N/A";

        const airline =
            (fr.Airline) ||
            (photo && photo.Airline) ||
            "N/A";

        return {
            Registration: registration,
            Type: type,
            Airline: airline,
            Thumbnail: photo ? photo.Thumbnail : "N/A",
            FullImage: photo ? photo.Image : "N/A"
        };

    } catch (e) {
        document.getElementById("log").innerText += `⚠️ Error with ${registration}: ${e}\n`;
        return {
            Registration: registration,
            Type: "N/A",
            Airline: "N/A",
            Thumbnail: "N/A",
            FullImage: "N/A"
        };
    }
}

async function startProcess() {
    const log = document.getElementById("log");
    log.innerText = "";

    const date = document.getElementById("date_input").value.trim();
    const airport = document.getElementById("airport_input").value.trim().toUpperCase();
    const regs = document.getElementById("regs_input").value.toUpperCase().split(/\s+/);

    const results = [];
    let counter = 0;

    for (let reg of regs) {
        log.innerText += `Searching ${reg}…\n`;

        const info = await fetchAircraftInfo(reg);

        log.innerText += `➡️  ${info.Type} – ${info.Airline}\n`;

        info.Date = date;
        info.Airport = airport;
        results.push(info);

        await new Promise(r => setTimeout(r, 500));

        counter++;
        if (counter === 12) {
            log.innerText += `\n⏳ API limit reached – waiting 75 seconds...\n\n`;
            await new Promise(r => setTimeout(r, 75000));
            counter = 0;
        }
    }

    createCSV(results);
}

function createCSV(data) {
    const header = ["Date", "Airport", "Registration", "Type", "Airline", "Thumbnail", "FullImage"];
    let csv = header.join(",") + "\n";

    data.forEach(row => {
        csv += header.map(h => row[h]).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "aircraft.csv";
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
