<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Planespotting</title>
<style>
    body {
        font-family: Arial;
        padding: 20px;
        background-color: black;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    textarea, input {
        width: 320px;
        background-color: black;
        border: 1px solid white;
        color: white;
        display: block;
        margin: 6px auto;
        padding: 6px;
    }
    button {
        padding: 10px 20px;
        margin-top: 10px;
        border: 1px solid white;
        background: transparent;
        color: white;
        font-size: small;
        cursor: pointer;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    #log {
        white-space: pre-line;
        margin-top: 20px;
        max-width: 800px;
        width: 90%;
        text-align: left;
    }
</style>
</head>
<body>

<h2>Aircraft registrations to CSV</h2>

<label>Date:</label><br>
<input id="date_input" type="text" placeholder="e.g. 12.11.2025"><br><br>

<label>Airport:</label><br>
<input id="airport_input" type="text" placeholder="e.g. PRG, OTP, CPH"><br><br>

<label>Registrations (separated by space):</label><br>
<textarea id="regs_input" rows="4" placeholder="OK-IOO YR-AME ..."></textarea><br>

<button onclick="startProcess()">Generate CSV</button>

<div id="log"></div>

<script>
async function fetchAircraftInfo(registration) {
    const realURL = `https://www.jetapi.dev/api?reg=${registration}&photos=1&flights=0`;
    const url = `https://corsproxy.io/?${realURL}`;

    try {
        const resp = await fetch(url, { headers: { "User-Agent": "Mozilla/5.0" }});
        if (!resp.ok) {
            document.getElementById("log").innerText += `❌ ${registration}: HTTP ${resp.status}\n`;
            return {
                Registration: registration,
                Type: "N/A",
                Airline: "N/A",
                Thumbnail: "N/A",
                FullImage: "N/A"
            };
        }

        const data = await resp.json();

        const fr = data.FlightRadar || {};
        const jp = data.JetPhotos || {};
        const images = jp.Images || [];
        const photo = images[0];

        const type =
            (fr.Aircraft) ||
            (photo && photo.Aircraft) ||
            "N/A";

        const airline =
            (fr.Airline) ||
            (photo && photo.Airline) ||
            "N/A";

        const thumbnail = photo ? photo.Thumbnail : "N/A";
        const fullImage = photo ? photo.Image : "N/A";

        return {
            Registration: registration,
            Type: type,
            Airline: airline,
            Thumbnail: thumbnail,
            FullImage: fullImage
        };

    } catch (e) {
        document.getElementById("log").innerText += `⚠️ Error with ${registration}: ${e}\n`;
        return {
            Registration: registration,
            Type: "N/A",
            Airline: "N/A",
            Thumbnail: "N/A",
            FullImage: "N/A"
        };
    }
}

async function startProcess() {
    const log = document.getElementById("log");
    log.innerText = "";

    const date = document.getElementById("date_input").value.trim();
    const airport = document.getElementById("airport_input").value.trim().toUpperCase();
    const regs = document.getElementById("regs_input").value.toUpperCase().split(/\s+/);

    const results = [];
    let counter = 0;

    for (let reg of regs) {
        log.innerText += `Searching ${reg} …\n`;

        const info = await fetchAircraftInfo(reg);

        log.innerText += `➡️  ${info.Type} – ${info.Airline}\n`;

        info.Date = date;
        info.Airport = airport;
        results.push(info);

        await new Promise(r => setTimeout(r, 500));

        counter++;
        if (counter === 12) {
            log.innerText += `\n⏳ API limit reached – waiting 75 seconds...\n\n`;
            await new Promise(r => setTimeout(r, 75000));
            counter = 0;
        }
    }

    createCSV(results);
}

function createCSV(data) {
    const header = ["Date", "Airport", "Registration", "Type", "Airline", "Thumbnail", "FullImage"];
    let csv = header.join(",") + "\n";

    data.forEach(row => {
        csv += header.map(h => row[h]).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "aircraft.csv";
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>

