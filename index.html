<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planespotting</title>
<style>
    body {
        font-family: Arial;
        padding: 20px;
        background-color: black;
        color: white;
        text-align: center;
    }
    textarea, input {
        width: 320px;
        background-color: black;
        border: 1px solid white;
        color: white;
        display: block;
        padding: 6px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-top: 5px;
    }
    button {
        padding: 10px 20px;
        margin-top: 10px;
        border: 1px solid white;
        background: transparent;
        color: white;
        font-size: small;
        cursor: pointer;
        display: block;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    #log {
        white-space: pre-line;
        margin-top: 20px;
        max-width: 800px;
        width: 90%;
        text-align: left;
        background: black;
        padding: 10px;
        border-radius: 6px;
    }
</style>
</head>
<body>

<h2>Aircraft registrations to CSV</h2>

<label>Date:</label><br>
<input id="date_input" type="text" placeholder="e.g. 12.11.2025"><br><br>

<label>Airport:</label><br>
<input id="airport_input" type="text" placeholder="e.g. PRG, OTP, CPH"><br><br>

<label>Registrations (separated by space):</label><br>
<textarea id="regs_input" rows="4" placeholder="OK-IOO YR-AME ..."></textarea><br>

<button onclick="startProcess()">Generate CSV</button>

<div id="log"></div>

<script>
async function fetchAircraftInfo(registration) {
    const realURL = `https://www.jetapi.dev/api?reg=${registration}&photos=0&flights=0`; // photos=0
    const url = `https://corsproxy.io/?${realURL}`;

    try {
        const resp = await fetch(url, { headers: { "User-Agent": "Mozilla/5.0" }});
        if (!resp.ok) {
            document.getElementById("log").innerText += `❌ ${registration}: HTTP ${resp.status}\n`;
            return {
                Registration: registration,
                Type: "N/A",
                Airline: "N/A"
            };
        }

        const data = await resp.json();

        const fr = data.FlightRadar || {};

        const type = fr.Aircraft || "N/A";
        const airline = fr.Airline || "N/A";

        return {
            Registration: registration,
            Type: type,
            Airline: airline
        };

    } catch (e) {
        document.getElementById("log").innerText += `⚠️ Error with ${registration}: ${e}\n`;
        return {
            Registration: registration,
            Type: "N/A",
            Airline: "N/A"
        };
    }
}

async function startProcess() {
    const log = document.getElementById("log");
    log.innerText = "";

    const date = document.getElementById("date_input").value.trim();
    const airport = document.getElementById("airport_input").value.trim().toUpperCase();
    const regs = document.getElementById("regs_input").value.toUpperCase().split(/\s+/);

    const results = [];
    let counter = 0;

    for (let reg of regs) {
        log.innerText += `Searching ${reg} …\n`;

        const info = await fetchAircraftInfo(reg);

        log.innerText += `➡️  ${info.Type} – ${info.Airline}\n`;

        info.Date = date;
        info.Airport = airport;
        results.push(info);

        await new Promise(r => setTimeout(r, 500));

        counter++;
        if (counter === 12) {
            log.innerText += `\n⏳ API limit reached – waiting 75 seconds...\n\n`;
            await new Promise(r => setTimeout(r, 75000));
            counter = 0;
        }
    }

    createCSV(results);
}
function createCSV(data) {
    const header = ["Date", "Airport", "Registration", "Type", "Airline"];
    let csv = header.join(",") + "\n";

    data.forEach(row => {
        csv += header.map(h => row[h]).join(",") + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    // sestavení bezpečného názvu souboru
    const airportInput = document.getElementById("airport_input").value.trim().toUpperCase();
    const airport = airportInput || "UNKNOWN";

    let dateInput = document.getElementById("date_input").value.trim();
    if (!dateInput) {
        const d = new Date();
        dateInput = String(d.getDate()).padStart(2, "0") + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + d.getFullYear();
    } else {
        // normalizovat různé oddělovače na pomlčku a odstranit opakované pomlčky
        dateInput = dateInput.replace(/[.\/\s]+/g, "-").replace(/[^0-9\-]/g, "-").replace(/-+/g, "-");
    }

    const filename = `${airport}_${dateInput}.csv`;

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
